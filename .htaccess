# =====================================================
# GLOBAL MASTER .htaccess — RMIT Group (htdocs)
# =====================================================

# -------------------------------
# Error Handling (already working)
# -------------------------------
ErrorDocument 400 /error.php?code=400
ErrorDocument 401 /error.php?code=401
ErrorDocument 403 /error.php?code=403
ErrorDocument 404 /error.php?code=404
ErrorDocument 500 /error.php?code=500
ErrorDocument 502 /error.php?code=502
ErrorDocument 503 /error.php?code=503
ErrorDocument 504 /error.php?code=504


# -------------------------------
# Basic Security
# -------------------------------
Options -Indexes

<FilesMatch "^(\.env|composer\.json|composer\.lock|package\.json|package-lock\.json|\.htaccess|\.htpasswd|config\.php|db\.php)$">
  Require all denied
</FilesMatch>


# -------------------------------
# Compression (Gzip + Brotli)
# -------------------------------
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE \
    text/html text/plain text/xml text/css \
    application/javascript application/json application/xml \
    image/svg+xml
</IfModule>

<IfModule mod_brotli.c>
  BrotliCompressionQuality 6
  AddOutputFilterByType BROTLI_COMPRESS \
    text/html text/plain text/xml text/css \
    application/javascript application/json application/xml \
    image/svg+xml
</IfModule>


# -------------------------------
# MIME Types (InfinityFree-safe)
# -------------------------------
<IfModule mod_mime.c>
  AddType image/webp .webp
  AddType image/jpeg .jpg .jpeg
  AddType image/png .png
  AddType image/gif .gif
  AddType image/svg+xml .svg
  AddType font/woff2 .woff2
  AddType font/woff .woff
</IfModule>


# -------------------------------
# Browser Caching (Expires)
# -------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML – short cache (dynamic-ish)
  ExpiresByType text/html "access plus 1 hour"

  # CSS & JS – medium cache
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"

  # Fonts
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"

  # Images – long cache
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
</IfModule>


# -------------------------------
# Cache-Control Headers
# -------------------------------
<IfModule mod_headers.c>

  <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|css|js|ico|woff2?|ttf|eot)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </FilesMatch>

  <FilesMatch "\.(html|htm|php|css|js)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  	Header set Pragma "no-cache"
  	Header set Expires 0
  </FilesMatch>

</IfModule>

# -------------------------------
# Security Headers (safe global)
# -------------------------------
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

  Header always set Content-Security-Policy "default-src 'self' https: data:; img-src 'self' https: data:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:;"
</IfModule>

# =====================================================
# Auto-serve WebP images (no HTML changes required)
# =====================================================
<IfModule mod_rewrite.c>
  RewriteEngine On

  RewriteCond %{HTTP_ACCEPT} image/webp
  RewriteCond %{REQUEST_FILENAME} (.+)\.(jpe?g|png)$
  RewriteCond %1.webp -f
  RewriteRule ^(.+)\.(jpe?g|png)$ $1.webp [T=image/webp,E=serve_webp,L]
</IfModule>

<IfModule mod_headers.c>
  Header append Vary Accept env=serve_webp
</IfModule>


# -------------------------------
# Disable ETags (better caching)
# -------------------------------
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>
FileETag None
php_value date.timezone Asia/Kolkata
